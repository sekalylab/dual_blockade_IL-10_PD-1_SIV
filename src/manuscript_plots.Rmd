---
title: "Dual blockade IL-10 / PD1 SIV - Plots"
author: "ten-Caten, Felipe - ftencat@emory.edu"
editor_options: 
  chunk_output_type: console
---

```{r Load libraries}
library(readxl)
library(tidyverse)
library(rstatix)
library(ggpubr)
library(ggrepel)
library(ggprism)
library(survival)
library(survminer)
library(grid)
library(pBrackets)
library(patchwork)
library(viridis)
library(circlize)
library(ComplexHeatmap)
library(corrplot)
library(pals)
```

```{r 1B & Extended 3A-C - Median line VL plot}
df <- read_tsv('data/raw_clean/plasma_viral_load.tsv') 

df.range <- df %>% 
  group_by(group, `WkPost-TX`) %>% 
  summarize(median = as.numeric(median_q1q3(VL)[1]), 
            min = as.numeric(median_q1q3(VL)[2]), 
            max = as.numeric(median_q1q3(VL)[3]))

vlplot <- df.range %>%
  ggplot(aes(`WkPost-TX`)) +
  geom_ribbon(aes(ymin = min, ymax = max, fill = group), alpha = 0.2) +
  geom_line(aes(y = median, colour = group), size = 1) +
  geom_segment(aes(x = -57 , y = 0, xend = -57, yend = 4e7), linetype = 2) +
  geom_segment(aes(x = 12 , y = 0, xend = 12, yend = 4e7), linetype = 2) +
  geom_segment(aes(x = 13.4 , y = 8, xend = 14.5, yend = 8), size = 2, 
               color = "#1B9E77") +
  geom_segment(aes(x = 14.5 , y = 5, xend = 34.5, yend = 5), size = 2, 
               color = "#D95F02") +
  geom_segment(aes(x = 18.5 , y = 3.2, xend = 19.5, yend = 3.2), 
               size = 2, color = "#7570B3") +
  geom_segment(aes(x = 25.5 , y = 3.2, xend = 34.5, yend = 3.2), 
               size = 2, color = "#7570B3") +
  annotate("label", label = "ART\nwk 6 p.i.", 
           x = -57, y = 8e7, size = 3, colour = "black") +
  annotate("label", label = "ATI", 
           x = 12, y = 8e7, size = 3, colour = "black") +
  scale_x_continuous(breaks= c( -57, -23, 12, 21, 28, 36),
                     labels = c( -69, -35, 0, 9, 16, 24)) +
  scale_y_continuous(trans = 'log10', 
                     breaks = c(10, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7, 1e8))+
  ylab('VL (cps/mL plasma)') +
  xlab('Weeks Post-ATI') +
  scale_fill_manual(values = c("red", "blue", "black"),
                    name = "Group") +
  scale_color_manual(values = c("red", "blue", "black"),
                     name = 'Group') +
  coord_cartesian(ylim = c(5, 1.1e8), xlim = c(-63,32)) +
  theme_prism() +
  theme(panel.grid.major.y = element_line(colour="grey85",
                                          linetype = 3, linewidth = 0.5),
        legend.title = element_text())

vlplot
#ggsave('results/figures/Fig1/Fig1B_median_viral_load.pdf', vlplot,
#       device = 'pdf', scale = 0.7)

### Viremia by group
df.wk.pi <- df %>% 
  mutate(group = factor(group, levels = c('Control', 'aIL-10', 'aIL-10+aPD-1'))) %>% 
  mutate(wk_postinfection = `WkPost-TX` + 65) %>%
  mutate(wk_postinfection = factor(wk_postinfection))

median.vl <- df %>% 
  mutate(group = factor(group, levels = c('Control', 'aIL-10', 'aIL-10+aPD-1'))) %>% 
  mutate(wk_postinfection = `WkPost-TX` + 65) %>% 
  group_by(wk_postinfection, group) %>% 
  summarise(VL = median(VL)) %>% 
  mutate(wk_postinfection = factor(wk_postinfection)) 

control.viremia  <- df.wk.pi %>% 
  filter(group == 'Control') %>% 
  ggplot(aes(x = wk_postinfection, y = VL, colour = group)) +
  geom_point(size = 0.5) +
  geom_line(aes(group = animal), linewidth = 0.1) +
  geom_line(data = median.vl %>% filter(group == 'Control'),
            linewidth = 1, aes(group = group)) +
  geom_segment(aes(x = '6' , y = 0, xend = '6', yend = 3e8), linetype=2,
               color = 'black') +
  geom_segment(aes(x = '77' , y = 0, xend = '77', yend = 3e8),
               linetype=2, color = 'black')+
  scale_y_continuous(trans = 'log10', breaks = c(0, 1e2, 1e4, 1e6, 1e8),
                     labels = c(0,2,4,6,8)) + 
  annotate("label", label = "ART", 
           x = '6', y = 5e8, size = 3, colour = "black") +
  annotate("label", label = "ATI", 
           x = '77', y = 5e8, size = 3, colour = "black") +
  geom_text_repel(data = df.wk.pi %>% 
                    filter(group == 'Control') %>% 
                    group_by(animal) %>% 
                    slice_tail(n = 1), 
                    aes(label = animal), size = 3, color = 'black',
                  xlim = c(49, 51.5), hjust = 0, segment.size = 0.2,
                  direction = "y", min.segment.length = 0) +
  scale_color_manual(values = 'black')+
  coord_cartesian(xlim = c(1, 47), ylim = c(8,1e8), clip = 'off') +
  theme_prism(base_size = 10) +
  theme(panel.grid.major.y = element_line(colour="grey85",
                                          linetype = 3, linewidth = 0.5),
        legend.title = element_text(),
        axis.text.x  = element_text(size = 6), legend.position = 'none',
        axis.ticks.x  = element_line( linewidth =  0.5),
        plot.margin = unit(c(1,2.5,0.5,0.5), "lines")) +
  labs(x = 'weeks post-infection', y = 'Control\nLog VL cps/ml') 

ail10.viremia  <- df.wk.pi %>% 
  filter(group == 'aIL-10') %>% 
  ggplot(aes(x = wk_postinfection, y = VL, colour = group)) +
  geom_point(size = 0.5) +
  geom_line(aes(group = animal), linewidth = 0.1) +
  geom_line(data = median.vl %>% filter(group == 'aIL-10'),
            linewidth = 1, aes(group = group)) +
  geom_segment(aes(x = '6' , y = 0, xend = '6', yend = 3e8), linetype=2,
               color = 'black') +
  geom_segment(aes(x = '77' , y = 0, xend = '77', yend = 3e8),
               linetype=2, color = 'black')+
  scale_y_continuous(trans = 'log10', breaks = c(0, 1e2, 1e4, 1e6, 1e8),
                     labels = c(0,2,4,6,8)) + 
  geom_text_repel(data = df.wk.pi %>% 
                    filter(group == 'aIL-10') %>% 
                    group_by(animal) %>% 
                    slice_tail(n = 1), 
                    aes(label = animal), size = 3, color = 'black',
                  xlim = c(49, 51.5), hjust = 0, segment.size = 0.2,
                  direction = "y", min.segment.length = 0) +
  annotate("label", label = "ART", 
           x = '6', y = 5e8, size = 3, colour = "black") +
  annotate("label", label = "ATI", 
           x = '77', y = 5e8, size = 3, colour = "black") +
  scale_color_manual(values = 'red')+
  coord_cartesian(xlim = c(1, 47), ylim = c(8,1e8), clip = 'off') +
  theme_prism(base_size = 10) +
  theme(panel.grid.major.y = element_line(colour="grey85",
                                          linetype = 3, linewidth = 0.5),
        legend.title = element_text(),
        axis.text.x  = element_text(size = 6), legend.position = 'none',
        axis.ticks.x  = element_line( linewidth =  0.5),
        plot.margin = unit(c(1,2.5,0.5,0.5), "lines")) +
  labs(x = 'weeks post-infection', y = 'aIL-10\nLog VL cps/ml')
  
ail10aPD1.viremia <- df.wk.pi %>% 
  filter(group == 'aIL-10+aPD-1') %>% 
  ggplot(aes(x = wk_postinfection, y = VL, colour = group)) +
  geom_point(size = 0.5) +
  geom_line(aes(group = animal), linewidth = 0.1) +
  geom_line(data = median.vl %>% filter(group == 'aIL-10+aPD-1'),
            linewidth = 1, aes(group = group)) +
  geom_segment(aes(x = '6' , y = 0, xend = '6', yend = 3e8), linetype=2,
               color = 'black') +
  geom_segment(aes(x = '77' , y = 0, xend = '77', yend = 3e8),
               linetype=2, color = 'black')+
  scale_y_continuous(trans = 'log10', breaks = c(0, 1e2, 1e4, 1e6, 1e8),
                     labels = c(0,2,4,6,8)) +
  geom_text_repel(data = df.wk.pi %>% 
                    filter(group == 'aIL-10+aPD-1') %>% 
                    group_by(animal) %>% 
                    slice_tail(n = 1), 
                    aes(label = animal), size = 3, color = 'black',
                  xlim = c(49, 51.5), hjust = 0, segment.size = 0.3,
                  direction = "y", min.segment.length = 0) +
  annotate("label", label = "ART", 
           x = '6', y = 5e8, size = 3, colour = "black") +
  annotate("label", label = "ATI", 
           x = '77', y = 5e8, size = 3, colour = "black") +
  scale_color_manual(values = 'blue')+
  coord_cartesian(xlim = c(1, 47), ylim = c(8,1e8), clip = 'off') +
  theme_prism(base_size = 10) +
  theme(panel.grid.major.y = element_line(colour="grey85",
                                          linetype = 3, linewidth = 0.5),
        legend.title = element_text(),
        axis.text.x  = element_text(size = 6), legend.position = 'none',
        axis.ticks.x  = element_line( linewidth =  0.5),
        plot.margin = unit(c(1,2.5,0.5,0.5), "lines")) +
  labs(x = 'weeks post-infection', y = 'aIL-10+aPD-1\nLog VL cps/ml')

p <- control.viremia / ail10.viremia / ail10aPD1.viremia
p
#ggsave('results/figures/EDFig3/group_viremia_per_week.pdf', p, width = 7, height = 9, 
#       units = 'in', device = 'pdf')
```

```{r 1C - Kaplan-Meier rebound plot}
vl <- read_tsv('data/raw_clean/plasma_viral_load.tsv')

# Control survival plot
vl.tidy <- vl %>% 
  mutate(control = ifelse(VL <= 1000, 1, 0)) %>% 
  mutate(`WkPost-ATI`= `WkPost-TX` - 12) %>% 
  filter(animal != 'median')
  
vl.tidy.wk12 <- vl.tidy %>% 
  filter(`WkPost-ATI` >= 2) %>% 
  filter(`WkPost-ATI` <= 24) %>% 
  filter(!is.na(VL)) 

vl.km <- vl.tidy.wk12 %>% 
  group_by(animal) %>% 
  filter(if(sum(control) == 0) `WkPost-ATI` == 24 else control == 1) %>% 
  filter(!duplicated(animal))

fit <- survfit(Surv(`WkPost-ATI`, control) ~ group, data = vl.km)

survplot <- ggsurvplot(fit, data = vl.km,  cumevents = T, fun = 'event', 
           risk.table.height = 0.25, pval = F, 
           palette = c("#FF0000","#0000FF" ,"#000000"),
           ylim = c(0,1), xlim = c(2,24),
            break.time.by = 4, size = 2) +
  xlab('WkPost-ATI') +
  ylab('Cumulative % of animals during\nATI with VL < 1000 cps/mL\nat least once') 

# From https://stackoverflow.com/a/35662327
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
} 

survplot.plot <- survplot$plot + 
  scale_color_manual(values = c("#FF0000","#0000FF" ,"#000000"),
                     labels = c('aIL-10', 'aIL-10+aPD-1', 'Control'),
                     name = '') +
  theme_prism() + 
  theme(legend.title = element_text(),
        legend.position  = 'top',
        plot.margin = unit(c(0,7,0,0), "lines")) +
  annotation_custom(grob = bracketsGrob(0.98, 0.44, 0.98, 0.16, h = 0.03, 
                                        lwd = 2, ticks=NA, type = 4, col="black")) + 
  annotation_custom(grob = bracketsGrob(0.98, 0.86, 0.98, 0.46, h = 0.03, 
                                        lwd = 2, ticks=NA, type = 4, col="black")) +
  annotation_custom(grob = bracketsGrob(1.07, 0.86, 1.07, 0.16, h = 0.03, 
                                        lwd = 2, ticks=NA, type = 4, col="black")) +
  annotation_custom(grid::textGrob("p=0.19", rot = 90,
                                   gp = gpar(fontsize = 14, fontface="bold")), 
                   xmax = 53, ymin = 0.1, ymax = 0.445) +
  annotation_custom(grid::textGrob("p=0.082", rot = 90,
                                   gp = gpar(fontsize = 14, fontface="bold")), 
                   xmax = 53, ymin = 0.5, ymax = 0.9) +
  annotation_custom(grid::textGrob("p=0.003", rot = 90,
                                   gp = gpar(fontsize = 14, fontface="bold")), 
                   xmax = 58, ymin = 0.1, ymax = 0.9) +
  annotation_custom(grid::textGrob("Log-rank", rot = 90,
                                   gp = gpar(fontsize = 16, fontface="bold")), 
                   xmax = 62, ymin = 0.1, ymax = 0.9) +
  coord_cartesian(clip = 'off') 
  

cumulative.event <- survplot$cumevents + 
  theme_prism() + 
  scale_y_discrete(labels = c('Control', 'aIL-10+aPD-1', 'aIL-10')) +
  ylab('')

final.surv.plot <- survplot.plot / cumulative.event + plot_layout(heights = c(4, 1))

final.surv.plot
#ggsave('results/figures/Fig1/Fig1C_kaplan_meier.pdf', final.surv.plot,
#       device = 'pdf', scale = 0.7)
```

```{r 1D & Extended 4E-H - CD4 Counts & Viral readouts correlation}
viral.ro <- read_tsv('data/raw_clean/viral_readouts_wk24_postati.tsv')

## CD4 Counts week 24 post-ati
cd4.count.plot <- viral.ro %>% 
  ggplot(aes(x = factor(group, levels = c('Control', 'aIL10', 'aIL10+aPD1')), 
             y = cd4_count_wk24_postati, fill = group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.05,  shape = 21, size = 3) +
  stat_compare_means(method = 'wilcox', label = 'p.signif', step.increase = 0.13,
                     size = 8, fontface = 'bold',
                     comparisons = list(c('Control', 'aIL10'),
                                        c('Control', 'aIL10+aPD1'),
                                        c('aIL10+aPD1', 'aIL10'))) +
  scale_fill_manual(values = c('red', 'blue', 'black')) +
  scale_y_continuous(limits = c(85,1600))+
  theme_prism() +
  theme(legend.position = "none",
         axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  labs(x = '', y = 'Absolute # CD4 T cells\n24 weeks post-ATI')

### Correlations
vl.cd4counts <- viral.ro %>% 
  ggplot(aes(y = cd4_count_wk24_postati, x = log_VL)) +
    geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             method = 'spearman', size = 5, cor.coef.name = 'rho',
             label.y = 8) +
    scale_color_manual(values = c('red','blue', 'black'), name = 'Group') +
    labs(x = 'log VL\nWeek 24 post-ATI',
         y = 'Absolute CD4 counts\nweek 24 post-ATI')+
    theme_prism() +
  theme(legend.title = element_text())

vl.sivrna <- viral.ro %>% 
  ggplot(aes(x = log_VL, y = `LOG_SIVRNA_LN_per10^6correctedCD4Live`)) +
    geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             method = 'spearman', size = 5, cor.coef.name = 'rho',
             label.y = 8) +
    scale_color_manual(values = c('red','blue', 'black'), name = 'Group') +
    labs(y = 'Log CA-vRNA - LN\nWeek 24 post-ATI',
         x = 'Log VL (cps/mL)')+
    theme_prism() +
  theme(legend.title = element_text())


sivrna.sivdna <- viral.ro %>% 
  ggplot(aes(x = `LOG_SIVRNA_LN_per10^6correctedCD4Live`, 
             y = `LOG_SIV/DNA_LN_per10^6correctedCD4Live`)) +
    geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             method = 'spearman', size = 5, cor.coef.name = 'rho',
             label.y = 4.5) +
    scale_color_manual(values = c('red','blue', 'black'), name = 'Group') +
    labs(x = 'Log CA-vRNA - LN\nWeek 24 post-ATI',
         y = 'Log CA-vDNA - LN\nWeek 24 post-ATI')+
    theme_prism() +
  theme(legend.title = element_text())

sivdna.ipda <- viral.ro %>% 
  ggplot(aes(y = `Total Proviruses Detected_Count Per Million CD4 live cells_LN`, 
             x = `LOG_SIV/DNA_LN_per10^6correctedCD4Live`)) +
    geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             method = 'spearman', size = 5, cor.coef.name = 'rho',
             label.y = 85000) +
    scale_color_manual(values = c('red','blue', 'black'), name = 'Group') +
    labs(y = 'IPDA - LN\nWeek 24 post-ATI',
         x = 'Log CA-vDNA - LN\nWeek 24 post-ATI')+
  scale_y_continuous(labels = c('0','3e4', '6e4'),
                     breaks = c(0,30000, 60000))+
  theme_prism() +
  theme(legend.title = element_text())

ltr.livecells <- viral.ro %>% 
  ggplot(aes(y = log10(`2LTR Circles_Count Per Million CD4 live cells_LN`), 
             x = log10(`Intact_Count Per Million CD4 live cells_LN`))) +
    geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             label.y = 4, 
             method = 'spearman', size = 5, cor.coef.name = 'rho') +
    scale_color_manual(values = c('red','blue', 'black'), name = 'Group') +
    labs(y = 'Log 2LTR - LN\nWeek 24 post-ATI',
         x = 'Log IPDA - LN\nWeek 24 post-ATI')+
    theme_prism() +
  theme(legend.title = element_text())


#ggsave('results/figures/Fig1/boxplot_CD4Counts_pergroup_week24-postATI.pdf', 
#       cd4.count.plot, device = 'pdf', height = 5.5, width = 3)
#ggsave('results/figures/EDFig4/correlation_ViralLoad_CD4Counts.pdf', 
#       vl.cd4counts, device = 'pdf', height = 5.5, width = 7)
#ggsave('results/figures/EDFig4/correlation_ViralLoad_SIVRNA.pdf', 
#       vl.sivrna, device = 'pdf', height = 5.5, width = 7)
#ggsave('results/figures/EDFig4/correlation_SIVRNA_SIVDNA.pdf', 
#       sivrna.sivdna, device = 'pdf', height = 5.5, width = 7)
#ggsave('results/figures/EDFig4/correlation_SIVDNA_IPDA.pdf', 
#       sivdna.ipda, device = 'pdf', height = 5.5, width = 7)
#ggsave('results/figures/EDFig4/correlation_LTR_Livecells.pdf',
#       ltr.livecells, device = 'pdf', height = 5.5, width = 7)
```

```{r 1E & H - SIVRNA / SIVDNA}
data <- read_tsv('data/raw_clean/sivdna_sivrna_wk0_wk24.tsv')

# SIV - RNA
sivrna.wk24 <- data %>% 
  dplyr::filter(`WkPost-ATI` == 24) %>% 
  ggplot(aes(x = factor(group, levels = c('Control', 'aIL10', 'aIL10+aPD1')), 
             y = `LOG_SIVRNA_LN_per10^6correctedCD4Live`, fill = group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.05,  shape = 21, size = 3) +
  stat_compare_means(method = 'wilcox', label = 'p.signif',  
                     size = 8, fontface = 'bold',
                     comparisons = list(c('Control', 'aIL10'),
                                        c('Control', 'aIL10+aPD1'),
                                        c('aIL10+aPD1', 'aIL10'))) +
  scale_fill_manual(values = c('red', 'blue', 'black')) +
  theme_prism() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_y_continuous(limits = c(1.3, 10))+
  labs(x = '', y = 'Log CA-vRNA/10^6 cells\n24 weeks post-ATI - LN')

sivrna.wk24
#ggsave('results/figures/Fig1/boxplot_sivrna_week24_postati_per_group.pdf',
#       sivrna.wk24, device = 'pdf', height = 5.5, width = 3)

## SIV-DNA
# From https://stackoverflow.com/a/35662327
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
} 

tbl <- data %>% 
  dplyr::select(animal, `WkPost-ATI`, group, 
                `LOG_SIV/DNA_LN_per10^6correctedCD4Live`) %>% 
  dplyr::filter(`WkPost-ATI` %in% c(0, 24)) %>% 
  dplyr::mutate(group = factor(group, levels = c('Control',
                                                 'aIL10', 'aIL10+aPD1'))) %>% 
  dplyr::mutate(phase = ifelse(`WkPost-ATI` == 0, 'pre', 'post')) %>% 
  dplyr::mutate(phase = factor(phase, levels = c('pre', 'post')))
  
width <- .25
tbl1 <- tbl %>%
  mutate(group = factor(group),
         x = as.numeric(group) + width * if_else(phase == "pre", -1, 1)) %>% 
  dplyr::mutate(group_phase = paste(group, phase, sep = '_'))

sivdna <- ggplot(tbl1, aes(x = x, y = `LOG_SIV/DNA_LN_per10^6correctedCD4Live`, 
                 fill = group, shape = phase)) +
  geom_line(aes(group = animal), alpha = 0.5) +
  scale_shape_manual(values =  c(21,22), name = '',
                     labels = c("Week 0 Post-ATI", "Week 24 Post-ATI"))+
  scale_fill_manual(values = c('black', 'red', 'blue'), guide="none") +
  geom_point(size= 3) +
  scale_x_continuous(breaks = c(1,2,3),
                     labels = c('Control', 'aIL10', 'aIL10+aPD1')) +
  geom_bracket(aes(xmin = min, xmax = max, label = p.adj.signif),
      label.size = 5, fontface = 'bold',
      data = tibble(min = 2.25, max = 3.25, p.adj.signif = '*', 
                    `LOG_SIV/DNA_LN_per10^6correctedCD4Live` = 3, 
                    group = 'aIL10',  phase = 'pre', y.position = 4.7)) +
  theme_prism() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = 'bottom',
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(-8, "pt"),
        plot.margin = unit(c(0.5,2,0,0.5), "lines")) +
#  annotation_custom(grob = bracketsGrob(0.97, 0.6, 0.97, 0.15, h = 0.03, 
#                                        lwd = 2, ticks=NA, type = 4, col="black")) +
#  annotation_custom(grid::textGrob("***", rot = 90,
#                                   gp = gpar(fontsize = 14, fontface="bold")), 
#                   xmax = 6.48, ymax = 3.8) +
#  geom_rect(aes(xmin = 3.15, xmax = 3.35 , ymin = 1.3, ymax = 2.05),
#               fill = "transparent", color = 'grey40', linetype =3)+
#  geom_rect(aes(xmin = 3.15, xmax = 3.35 , ymin = 2.35, ymax = 4.4),
#               fill = "transparent", color = 'grey40', linetype =3)+
  labs(x = '', y = 'Log CA-vDNA/10^6 cells\nLive CD4+ T cells - LN') +
  coord_cartesian(clip = 'off')

sivdna
#ggsave('results/figures/Fig1/boxplot_sivdna_wk0_wk24_postati_per_group.pdf',
#       sivdna, device = 'pdf', height = 5.5, width = 5)
```

```{r 2B-G & 3B-C & Extended 5A-B & Extended 7 & Extended 8 - Boxplots, Correlation & Longitudinal }
features <- read_tsv('data/raw_clean/features_correl_vrna_wk24.tsv')

fs <- c(features$var2, 
        'wk12_IL10', 'wk12_MSD_Cluster_1', 'wk12_MSD_Cluster_2', 'wk12_MSD_Cluster_3')

modulated.feat <- read_tsv('results/linear_regression_group_comparison.tsv') %>% 
  mutate(feature = paste0('wk', WkPost.TX, '_', parameter))

barplot.stats <- modulated.feat %>% 
  filter(feature %in% fs) %>%
  relocate(feature) %>% 
  dplyr::select(-parameter)

#write_tsv(barplot.stats,
#          'results/figures/boxplots_feature_selection/barplots_linear_model_stats.tsv')

df <- read_tsv('data/raw_clean/flow_raw_values_signif_features.tsv') %>% 
  mutate(group = factor(group, levels = c('Control', 'aIL10', 'aIL10+aPD1')))

modulated.feat.p.adj.signif <- modulated.feat %>%
  filter(feature %in% fs) %>% 
  select(feature, `ref.group`, term, p.value.adj) %>% 
  rename(group1 = `ref.group`, group2 = term, p.adj = p.value.adj) %>% 
  mutate(group2 = gsub('group', '', group2)) %>% 
  mutate(p.adj.signif = case_when(p.adj > 0.05 ~ 'ns',
                                  p.adj <= 0.05 & p.adj > 0.01 ~ '*',
                                  p.adj <= 0.01 & p.adj > 0.001 ~ '**',
                                  p.adj <= 0.001  ~ '***'))

modulated.feat.p.adj.signif.stat <- modulated.feat.p.adj.signif %>% 
  left_join(df %>% 
              filter(feature %in% fs) %>%  
              group_by(feature) %>% 
              slice_max(value, with_ties = F) %>% 
              select(feature, value)) %>% 
  mutate(value = ifelse(p.adj.signif == 'ns', NA, value))

### BOXPLOT ----
df.boxplot <- df %>% 
  mutate(unit = paste0(unit, '\n')) %>% 
  mutate(ylabel = paste0(newname,' ', unit, timepoint, ' - ', tissue))

boxplot.list <- list()
for (i in 1:length(fs)) {
  boxplot.list[[i]] <- df.boxplot %>% 
    filter(feature %in% fs[i]) %>% 
    ggplot(aes(x = group, y = value)) +
    geom_boxplot(aes(fill = group), alpha = 0.7, outlier.shape = NA) +
    geom_jitter(aes(fill = group), width = 0.05,  shape = 21, size = 3) +
    geom_bracket(
      aes(xmin = group1, xmax = group2, label = p.adj.signif, 
          y.position = value + value*0.05),
      step.increase = 0.1, label.size = 10, 
      fontface = 'bold', vjust = 0.6,
      data = modulated.feat.p.adj.signif.stat %>% 
        filter(feature %in% fs[i])) +
    scale_fill_manual(values = c("black", "red", "blue")) +
    theme_prism() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
    ylab(df.boxplot %>% filter(feature %in% fs[i]) %>% 
                 select(ylabel) %>% unique()) +
    xlab('') 
}
names(boxplot.list) <- fs

## Save plots
#boxplot_path  <- 'results/figures/boxplots_feature_selection/'
#lapply(names(boxplot.list), 
#       function(x) ggsave(paste0(boxplot_path, x, '.pdf'), 
#                          plot = boxplot.list[[x]], width = 3, 
#                          height = 5.5, bg = 'white', device = 'pdf'))

### CORRELATION ----
rna.cor.df <- df %>% 
  filter(feature %in% fs) %>% 
  left_join(df %>% 
              filter(feature == 'wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live') %>% 
              select(animal, value) %>% 
              rename(`wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live` = value)) %>% 
  mutate(unit = paste0(unit, '\n')) %>% 
  mutate(ylabel = paste0(newname,' ', unit, timepoint, ' - ', tissue)) %>% 
  relocate(animal, group, `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`)

siv.rna.cor.test <- rna.cor.df %>% 
  select(animal, `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`, name, value) %>% 
  pivot_wider(names_from = name, values_from = value) %>% 
  cor_test(vars = `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`, 
           method = 'spearman')

#write_tsv(siv.rna.cor.test,
#          'results/figures/correlation_to_siv_rna_feature_selection/spearman_correlation_results.tsv')

params <- unique(rna.cor.df$feature)
cor.plot.list <- list()
for (i in 1:length(params)) {
cor.plot.list[[i]] <-  rna.cor.df %>% 
  filter(feature == params[i]) %>% 
    {ggplot(., aes(x = `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`, 
                   y = value)) +
    geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             label.y = max(.$value, na.rm = T) + (max(.$value, na.rm = T)*0.05), 
             method = 'spearman', size = 5, cor.coef.name = 'rho') +
    scale_color_manual(values = c('black', 'red', 'blue'), name = 'Group') +
    ylab(unique(.$ylabel)) +
    xlab('Log CA-vRNA - LN\nWeek 24 post-ATI') +   
    theme_prism() +
   theme(legend.title = element_text())
    }}
names(cor.plot.list) <- params

## Save plots
#correlation_path  <- 'results/figures/correlation_to_siv_rna_feature_selection/'
#lapply(names(cor.plot.list), 
#       function(x) ggsave(paste0(correlation_path, x, '.pdf'), 
#                          plot = cor.plot.list[[x]], width = 7, 
#                          height = 5.5, bg = 'white', device = 'pdf'))

### LONGITUDINAL ----
params <- unique(sub('wk[0-9][0-9]_', "", fs))

stat.tbl <- modulated.feat %>% 
  select(parameter, `ref.group`, term, p.value.adj, WkPost.TX) %>% 
  rename(group1 = `ref.group`, group2 = term, p.adj = p.value.adj) %>% 
  mutate(group2 = gsub('group', '', group2)) %>% 
  mutate(p.adj.signif = case_when(p.adj > 0.05 ~ 'ns',
                                  p.adj <= 0.05 & p.adj > 0.01 ~ '*',
                                  p.adj <= 0.01 & p.adj > 0.001 ~ '**',
                                  p.adj <= 0.001  ~ '***')) %>% 
  mutate(x.pos.min = case_when(group1 == 'aIL10+aPD1' & 
                                 group2 == 'aIL10' ~ WkPost.TX + 0.1,
                           group1 == 'aIL10+aPD1' & 
                             group2 == 'Control' ~ WkPost.TX - 1.35,
                           group1 == 'Control' ~ WkPost.TX - 1.35),
         x.pos.max = case_when(group1 == 'aIL10+aPD1' & 
                                 group2 == 'aIL10' ~ WkPost.TX + 1.35,
                           group1 == 'aIL10+aPD1' & 
                             group2 == 'Control' ~ WkPost.TX + 1.35,
                           group1 == 'Control' ~ WkPost.TX - 0.1)) %>% 
  relocate(WkPost.TX, parameter, group1, group2, p.adj, p.adj.signif, x.pos.min,
           x.pos.max) %>% 
  filter(!is.na(parameter)) 

df.range <- df %>% 
  group_by(group, `WkPost-TX`, parameter) %>% 
  summarize(median = as.numeric(median_q1q3(value)[1]), 
            min = as.numeric(median_q1q3(value)[2]), 
            max = as.numeric(median_q1q3(value)[3]))

longitudinal.plot.list <- list()
for (i in seq_along(params)) {
  xannot <- stat.tbl %>% 
    filter(parameter == params[i], p.adj <= 0.05)
  
  yannot <- df %>%
    filter(parameter == params[i]) %>% 
    group_by(`WkPost-TX`, group) %>%   
    mutate(uw = max(value[value <= quantile(value, 0.75) + IQR(value)*1.5]),
           lw = min(value[value >= quantile(value, 0.25) - IQR(value)*1.5])) %>% 
    select(`WkPost-TX`, uw, lw) %>% 
    rename(`WkPost.TX` = `WkPost-TX`)
  
  yannot.max <- yannot %>% 
    unique() %>% 
    group_by(`WkPost.TX`) %>% 
    slice_max(uw, n = 1)
  
  yannot.min <- yannot %>% 
    ungroup() %>% 
    unique() %>% 
    slice_min(lw, n = 1)
  
  y.range <- (max(yannot.max$uw) + max(yannot.max$uw)*0.2) - min(yannot.min$lw)
  
  if(nrow(xannot) == 0) {pannot <- tibble(x.pos.min = 0, x.pos.max = 0, 
                                             y.pos = 0, p.adj.signif = NA)}
  else {
  pannot <- xannot %>% 
    left_join(yannot.max, by = 'WkPost.TX')  %>% 
    mutate(y.pos = case_when(group2 == 'aIL10' ~ uw + (y.range*0.13),
                             group2 == 'Control' ~ uw + (y.range*0.05))) %>% 
    select(-uw)
  }
  
  ylabel = df %>%
    filter(parameter == params[i]) %>% 
    mutate(newname = gsub('CD8p ', 'CD8p\n', newname)) %>% 
    mutate(newname = gsub('CD4p ', 'CD4p\n', newname)) %>% 
    mutate(ylabel = paste0(newname,' ', unit, ' - ', tissue)) %>% 
    select(ylabel) %>% 
    unique %>% 
    deframe()

  df.spline <- df.range %>% 
    filter(parameter == params[i]) %>% 
    group_by(group)  %>% 
    summarise(x = spline(`WkPost-TX`, median, n = 100, method = "natural")$x,
              y = spline(`WkPost-TX`, median, n = 100, method = "natural")$y,
              .groups = "keep")
  
  longitudinal.plot.list[[i]] <- df %>%
    filter(parameter == params[i]) %>% 
    ggplot(aes(x = `WkPost-TX`, y = value)) +
    geom_boxplot(aes(fill = group, group = interaction(`WkPost-TX`, group)),
               outlier.shape = NA, position = position_dodge(width = 4), 
               alpha = 0.7, width = 4) +
    geom_line(data = df.spline,
              aes(x = x, y = y, colour = group), linewidth = 1, alpha = 0.7) +
    geom_bracket(xmin = pannot$x.pos.min, xmax  = pannot$x.pos.max,
                 y.position = pannot$y.pos,
                 label = pannot$p.adj.signif,
                 tip.length = 0.01, vjust = 0.5, label.size = 8,
                 fontface = 'bold') +
    scale_x_continuous(breaks = sort(unique(df$`WkPost-TX`)),
                       labels = c('-13', '-5', '0', '9', '24')) +
    coord_cartesian(ylim = c(min(yannot.min$lw), 
                             max(yannot.max$uw) + max(yannot.max$uw)*0.2)) +
    facet_wrap(~ parameter, scale = 'free') +
    scale_shape_manual(name = 'Year batch', values = c(24, 21)) + 
    scale_fill_manual(values = c("black","red", "blue"), name = 'Group') +
    scale_color_manual(values = c( "black","red", "blue"), name = 'Group') +
    xlab('Weeks post-ATI') +
    ylab(ylabel)+
    theme_prism() +
    theme(strip.background = element_blank(), strip.text.x = element_blank(),
          legend.title = element_text())
}
names(longitudinal.plot.list) <- params

# Save plots
longitudinal_path  <- 'results/figures/longitudinal_plots_feature_selection/'
lapply(names(longitudinal.plot.list), 
       function(x) ggsave(paste0(longitudinal_path, x, '.pdf'), 
                          plot = longitudinal.plot.list[[x]], width = 7, 
                          height = 5.5, bg = 'white', device = 'pdf'))

```

```{r 4E, F, K, L - Cluster frequency correlation & longitudinal}
df <- read_tsv('data/raw_clean/flow_raw_values_signif_features.tsv') %>% 
  mutate(group = factor(group, levels = c('Control', 'aIL10', 'aIL10+aPD1')))

# SIV-RNA wk24 post-ATI
siv.rna <- df %>% 
  filter(`WkPost-TX` == 36, 
         parameter == 'LOG_SIVRNA_LN_per10^6correctedCD4Live') %>% 
  dplyr::select(animal, value) %>%  
  rename(Animal = animal, `LOG_SIVRNA_LN_per10^6correctedCD4Live` = value)

### CD4 Correlation Cluster 9 ----
cd4.stats <- read_excel('data/raw_clean/CD4_unsupflow_masterfile.xlsx',
                        sheet = 'Stats')

cd4.data <- read_excel('data/raw_clean/CD4_unsupflow_masterfile.xlsx',
                        sheet = 'CD4_data')

### cluster 9 week 24 post-ATI (wk 36 post-TX)
cd4.data %>% 
  filter(louvain == 9, `Week Post-TX` ==  'thirty_six') %>% 
  wilcox_test(relative_frequency ~ group)

cd4.data.sivrna <- cd4.data %>% 
  filter(louvain == 9, `Week Post-TX` ==  'thirty_six') %>% 
  left_join(siv.rna)

cd4.cluster9_wk36 <- cd4.data.sivrna %>% 
  {ggplot(., aes(x = `LOG_SIVRNA_LN_per10^6correctedCD4Live`,
             y = relative_frequency)) +
  geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             method = 'spearman', size = 5, cor.coef.name = 'rho') +
    scale_color_manual(values = c('red','blue', 'black'), name = 'Group') +
    ylab('CD4+ Cluster 9 %\nWeek 24 post-ATI') +
    xlab('Log CA-vRNA - LN\nWeek 24 post-ATI') +   
    scale_y_continuous(limits = c(0,0.06),
                       breaks = c(0, 0.02, 0.04, 0.06),
                       labels = c('0', '2', '4', '6')) +
      theme_prism()+
      theme(legend.title = element_text())
    }
  
#ggsave('results/figures/Fig4/correlation_cd4_cluster_9_sivrna_wk24.pdf', 
#       cd4.cluster9_wk36, device = 'pdf', height = 5.5, width = 7)

### CD8 Correlation Cluster 2 ----
cd8.stats <- read_excel('data/raw_clean/CD8_unsupflow_masterfile.xlsx',
                        sheet = 'Stats')

cd8.data <- read_excel('data/raw_clean/CD8_unsupflow_masterfile.xlsx',
                        sheet = 'CD8_data')

### cluster 2 week 24 post-ATI (wk 36 post-TX)
cd8.data %>% 
  filter(louvain == 2, `Week Post-TX` ==  'thirty_six') %>% 
  wilcox_test(relative_frequency ~ group, ref.group = 'aIL10+aPD1')

cd8.data.sivrna <- cd8.data %>% 
  filter(louvain == 2, `Week Post-TX` ==  'thirty_six') %>% 
  left_join(siv.rna)

cd8.cluster2_wk36 <- cd8.data.sivrna %>% 
  {ggplot(., aes(x = `LOG_SIVRNA_LN_per10^6correctedCD4Live`,
             y = relative_frequency)) +
  geom_point(aes(colour = group), size = 3) +
    geom_smooth(method = 'lm', se = F) +
    stat_cor(aes(label = paste(paste("'rho'", ..r.., sep = "~`=`~"), 
                               ..p.label.., sep = "~`,`~")),
             method = 'spearman', size = 5, cor.coef.name = 'rho',
             label.y = 0.35) +
    scale_color_manual(values = c('red','blue', 'black'), name = 'Group') +
    ylab('CD8+ Cluster 2 %\nWeek 24 post-ATI') +
    xlab('Log CA-vRNA - LN\nWeek 24 post-ATI') +   
    theme_classic() +
      scale_y_continuous(breaks = c(0.1, 0.2, 0.3),
      labels = c('10', '20', '30')) +
    theme_prism()+
    theme(legend.title = element_text()) }
  
#ggsave('results/figures/Fig4/correlation_cd8_cluster_2_sivrna_wk24.pdf', 
#      cd8.cluster2_wk36, 
#       device = 'pdf', height = 5.5, width = 7)

### Longitudinal CD4 & CD8 ----
cd4.cd8.data <- cd4.data %>% 
  filter(louvain == 9) %>% 
  mutate(cell = 'CD4') %>% 
  bind_rows(cd8.data %>% 
              filter(louvain == 2) %>% 
              mutate(cell = 'CD8')) %>% 
  mutate(`Week Post-TX` = case_when(`Week Post-TX` == 'minus_one' ~ -1,
                                    `Week Post-TX` == 'seven' ~ 7,
                                    `Week Post-TX` == 'twelve' ~ 12,
                                    `Week Post-TX` == 'twenty_one' ~ 21,
                                    `Week Post-TX` == 'thirty_six' ~ 36)) %>% 
  mutate(relative_frequency = relative_frequency*100) %>% 
  mutate(group = factor(group, levels = c('Control', 'aIL10', 'aIL10+aPD1')))
  
stats.tbl <- cd4.cd8.data %>% 
  group_by(`Week Post-TX`, louvain) %>% 
  wilcox_test(relative_frequency ~ group, p.adjust.method = 'BH',
              ref.group = 'aIL10+aPD1')

stats.tbl <- stats.tbl %>% 
  group_by(louvain) %>% 
  mutate(p.adj.signif = case_when(p.adj > 0.05 ~ 'ns',
                                  p.adj <= 0.05 & p.adj > 0.01 ~ '*',
                                  p.adj <= 0.01 & p.adj > 0.001 ~ '**',
                                  p.adj <= 0.001  ~ '***')) %>% 
  mutate(x.pos.min = case_when(group1 == 'aIL10+aPD1' & 
                               group2 == 'aIL10' ~ `Week Post-TX` + 0.1,
                               group1 == 'aIL10+aPD1' & 
                               group2 == 'Control' ~ `Week Post-TX` - 1.35,
                               group1 == 'Control' ~ `Week Post-TX` - 1.35),
         x.pos.max = case_when(group1 == 'aIL10+aPD1' & 
                               group2 == 'aIL10' ~ `Week Post-TX` + 1.35,
                               group1 == 'aIL10+aPD1' & 
                               group2 == 'Control' ~ `Week Post-TX` + 1.35,
                               group1 == 'Control' ~ `Week Post-TX` - 0.1)) 

df.range <- cd4.cd8.data %>% 
  group_by(group, `Week Post-TX`, louvain) %>% 
  summarize(median = as.numeric(median_q1q3(relative_frequency)[1]), 
            min = as.numeric(median_q1q3(relative_frequency)[2]), 
            max = as.numeric(median_q1q3(relative_frequency)[3]))

param.plot <- list()
params <- unique(cd4.cd8.data$louvain)

for(i in 1:length(params)) {
  xannot <- stats.tbl %>% 
    filter(louvain == params[i], p.adj <= 0.05)
  
  yannot <- cd4.cd8.data %>%
    filter(louvain == params[i]) %>% 
    group_by(`Week Post-TX`, group) %>%   
    mutate(uw = max(relative_frequency[relative_frequency <= 
                            quantile(relative_frequency, 0.75) + 
                            IQR(relative_frequency )*1.5]),
           lw = min(relative_frequency[relative_frequency  >= 
                            quantile(relative_frequency, 0.25) - 
                            IQR(relative_frequency )*1.5])) %>% 
    select(`Week Post-TX`, uw, lw) 
  
  yannot.max <- yannot %>% 
    unique() %>% 
    group_by(`Week Post-TX`) %>% 
    slice_max(uw, n = 1)
  
  yannot.min <- yannot %>% 
    ungroup() %>% 
    unique() %>% 
    slice_min(lw, n = 1)
  
  y.range <- (max(yannot.max$uw) + max(yannot.max$uw)*0.2) - min(yannot.min$lw)
  
  if(nrow(xannot) == 0) {pannot <- tibble(x.pos.min = 0, x.pos.max = 0, 
                                             y.pos = 0, p.adj.signif = NA)}
  else {
  pannot <- xannot %>% 
    left_join(yannot.max, by = 'Week Post-TX')  %>% 
    mutate(y.pos = case_when(group2 == 'aIL10' ~ uw + (y.range*0.13),
                             group2 == 'Control' ~ uw + (y.range*0.05))) %>% 
    select(-uw)
  }


df.spline <- df.range %>% 
    filter(louvain == params[i]) %>% 
    group_by(group)  %>% 
    summarise(x = spline(`Week Post-TX`, median, n = 100, method = "natural")$x,
              y = spline(`Week Post-TX`, median, n = 100, method = "natural")$y,
              .groups = "keep")

param.plot[[i]] <- cd4.cd8.data %>%
    filter(louvain == params[i]) %>% 
    ggplot(aes(x = `Week Post-TX`, y = relative_frequency)) +
    geom_boxplot(aes(fill = group, group = interaction(`Week Post-TX`, group)),
               outlier.shape = NA, position = position_dodge(width = 4), 
               alpha = 0.7, width = 4) +
    geom_line(data = df.spline,
              aes(x = x, y = y, colour = group), linewidth = 1, alpha = 0.7) +
    geom_bracket(xmin = pannot$x.pos.min, xmax  = pannot$x.pos.max,
                 y.position = pannot$y.pos,
                 label = pannot$p.adj.signif,
                 tip.length = 0.01, vjust = 0.5, label.size = 8,
                 fontface = 'bold') +
    scale_x_continuous(breaks = c(-1, 7, 12, 21, 36),
                       labels = c('-13', '-5', '0', '9', '24')) +
    coord_cartesian(ylim = c(min(yannot.min$lw), 
                             max(yannot.max$uw) + max(yannot.max$uw)*0.2)) +
    scale_fill_manual(values = c("black","red", "blue"), name = 'Group') +
    scale_color_manual(values = c( "black","red", "blue"), name = 'Group') +
    xlab('Weeks post-ATI') +
  ylab(paste0('LN ', cd4.cd8.data %>% filter(louvain == params[i]) %>% 
                select(cell) %>% deframe(), 
              '+ ','Cluster ', params[i], ' %')) + 
    theme_prism() +
  theme(legend.title = element_text(),
    strip.background = element_blank(), strip.text.x = element_blank())
}

names(param.plot) <- paste0('Cluster ', params)

# Save plots
#longitudinal_path  <- 'results/figures/Fig4/'
#lapply(names(param.plot), 
#       function(x) ggsave(paste0(longitudinal_path, x, '.pdf'), 
#                          plot = param.plot[[x]], width = 7, 
#                          height = 5.5, bg = 'white', device = 'pdf'))
```

```{r 6A-F Temporal dynamic plots}
# Load raw data
df <- read_tsv('data/raw_clean/flow_raw_values_signif_features.tsv') %>% 
  mutate(group = factor(group, levels = c('Control', 'aIL10', 'aIL10+aPD1'))) %>% 
  select(animal, group, `WkPost-TX`, parameter, value)

# Load grouped features info
features <- read_tsv('data/raw_clean/modulated_feature_groups.tsv')

# Load plasma viral load data
viremia <- read_tsv('data/raw_clean/plasma_viral_load.tsv') %>% 
  filter(`WkPost-TX` >= -1, `WkPost-TX` <= 36) %>% 
  mutate(group = gsub('-', '', group)) %>% 
  mutate(group = factor(group, levels = c('Control', 'aIL10', 'aIL10+aPD1')))

# Calculate scaled feature value
scaled.features <- features %>% 
  mutate(feature = gsub("wk[0-9][0-9]_", "", feature)) %>%
  left_join(df, by = c('feature' = 'parameter')) %>% 
  mutate(feature.group = case_when(grepl('LN_', feature) ~ 
                                        paste0('LN_', feature.group),
                                  grepl('PBMC_', feature) ~ 
                                 paste0('PBMC/Plasma_', feature.group),
                            TRUE ~ paste0('PBMC/Plasma_', feature.group))) %>%   
  group_by(feature) %>% 
  mutate(scaled.value = scale(value)[,1])  

# Calculate median pVL
viremia.median <- viremia %>% 
  mutate(scaled.value = scale(log10(VL))[,1]) %>% 
  group_by(`WkPost-TX`, group) %>% 
  summarise(median = median(scaled.value, na.rm = T)) %>% 
  mutate(Feature = 'Viral load', Tissue = 'PBMC/Plasma')

# Individual plots per group 
colors <- RColorBrewer::brewer.pal(6, 'Dark2')
exhaustion <- scaled.features %>% 
  separate(feature.group, c('Tissue', "Feature"), sep = '_') %>% 
  mutate(Tissue = factor(Tissue, levels = c('PBMC/Plasma', 'LN'))) %>% 
  filter(Feature %in% c('Exhaustion')) %>% 
  ggplot(aes(x = `WkPost-TX`, y = scaled.value)) +
  geom_line(data = viremia.median, 
            aes(x = `WkPost-TX`, y = median, colour = Feature), alpha = 0.8, 
            linewidth = 1) +
  geom_smooth(aes(linetype = Tissue, colour = Feature),
              method = 'loess', se = F) +
  scale_color_manual(values = c(colors[1], "#000000")) +
  scale_x_continuous(labels = c('-13', '-5', '0', '9', '24'),
                     breaks = c(-1, 7, 12, 21, 36)) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab('Exhaustion') +
  xlab('') +
  facet_wrap(~group) +
  expand_limits(y = c(-1.2, 1.5))

stemness <- scaled.features %>% 
  separate(feature.group, c('Tissue', "Feature"), sep = '_') %>% 
  mutate(Tissue = factor(Tissue, levels = c('PBMC/Plasma', 'LN'))) %>% 
  filter(Feature %in% c('Stemness')) %>% 
  ggplot(aes(x = `WkPost-TX`, y = scaled.value)) +
  geom_line(data = viremia.median, 
            aes(x = `WkPost-TX`, y = median, colour = Feature), alpha = 0.8, 
            linewidth = 1) +
  geom_smooth(aes(colour = Feature, linetype = Tissue),
              method = 'loess', se = F, linetype = 2) +
  scale_color_manual(values = c(colors[2], "#000000")) +
  scale_y_continuous(breaks = c(-1, 0 ,1))+
  scale_x_continuous(labels = c('-13', '-5', '0', '9', '24'),
                     breaks = c(-1, 7, 12, 21, 36)) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab('Stemness') +
  xlab('') +
  facet_wrap(~group, ) +
  expand_limits(y = c(-1.2, 1.5))

sivspecific <- scaled.features %>% 
  separate(feature.group, c('Tissue', "Feature"), sep = '_') %>% 
  mutate(Tissue = factor(Tissue, levels = c('PBMC/Plasma', 'LN'))) %>% 
  filter(Feature %in% c('SIV-specific')) %>% 
  ggplot(aes(x = `WkPost-TX`, y = scaled.value)) +
  geom_line(data = viremia.median, 
            aes(x = `WkPost-TX`, y = median, colour = Feature), alpha = 0.8, 
            linewidth = 1) +
  geom_smooth(aes(linetype = Tissue, colour = Feature),
              method = 'loess', se = F) +
  scale_color_manual(values = c(colors[3], "#000000")) +
  scale_x_continuous(labels = c('-13', '-5', '0', '9', '24'),
                     breaks = c(-1, 7, 12, 21, 36)) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab('SIV-specific') +
  xlab('Weeks Post ATI') +
  facet_wrap(~group) +
  expand_limits(y = c(-1.2, 1.5))

activation <- scaled.features %>% 
  separate(feature.group, c('Tissue', "Feature"), sep = '_') %>% 
  mutate(Tissue = factor(Tissue, levels = c('PBMC/Plasma', 'LN'))) %>% 
  filter(Feature %in% c("Activation/Differentiation")) %>% 
  ggplot(aes(x = `WkPost-TX`, y = scaled.value)) +
  geom_line(data = viremia.median, 
            aes(x = `WkPost-TX`, y = median, colour = Feature), alpha = 0.8, 
            linewidth = 1) +
  geom_smooth(aes(linetype = Tissue, colour = Feature),
              method = 'loess', se = F) +
  scale_color_manual(values = c(colors[4], "#000000")) +
  scale_x_continuous(labels = c('-13', '-5', '0', '9', '24'),
                     breaks = c(-1, 7, 12, 21, 36)) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab('Activation / Differentiation') +
  xlab('') +
  facet_wrap(~group) +
  expand_limits(y = c(-1.2, 1.5))

cytokines <- scaled.features %>% 
  separate(feature.group, c('Tissue', "Feature"), sep = '_') %>% 
  mutate(Tissue = factor(Tissue, levels = c('PBMC/Plasma', 'LN'))) %>% 
  filter(Feature %in% c("Cytokines")) %>% 
  ggplot(aes(x = `WkPost-TX`, y = scaled.value)) +
  geom_line(data = viremia.median, 
            aes(x = `WkPost-TX`, y = median, colour = Feature), alpha = 0.8, 
            linewidth = 1) +
  geom_smooth(aes(linetype = Tissue, colour = Feature),
              method = 'loess', se = F) +
  scale_color_manual(values = c(colors[5], "#000000")) +
  scale_x_continuous(labels = c('-13', '-5', '0', '9', '24'),
                     breaks = c(-1, 7, 12, 21, 36)) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab('Cytokines') +
  xlab('') +
  facet_wrap(~group) +
  expand_limits(y = c(-1.2, 1.5))

bcl2 <- scaled.features %>% 
  separate(feature.group, c('Tissue', "Feature"), sep = '_') %>% 
  mutate(Tissue = factor(Tissue, levels = c('PBMC/Plasma', 'LN'))) %>% 
  filter(Feature %in% c("BCL2")) %>% 
  ggplot(aes(x = `WkPost-TX`, y = scaled.value)) +
  geom_line(data = viremia.median, 
            aes(x = `WkPost-TX`, y = median, colour = Feature), alpha = 0.8, 
            linewidth = 1) +
  geom_smooth(aes(linetype = Tissue, colour = Feature),
              method = 'loess', se = F) +
  scale_color_manual(values = c(colors[6], "#000000")) +
  scale_x_continuous(labels = c('-13', '-5', '0', '9', '24'),
                     breaks = c(-1, 7, 12, 21, 36)) +
  theme_classic() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab('BCL2') +
  xlab(label = '') +
  facet_wrap(~group) +
  expand_limits(y = c(-1.2, 1.5))

top_plot  <- wrap_elements(bcl2 + cytokines + activation)
bottom_plot  <- wrap_elements(exhaustion + stemness + sivspecific)

p <- top_plot / bottom_plot

p
#ggsave('results/figures/Fig6/Fig6A-F_temporal_dynamic_plot.pdf', p, device = 'pdf')
```

```{r 6G - Chord plot}
# Load grouped features info
df <- read_tsv('data/raw_clean/modulated_feature_groups.tsv') %>% 
  mutate(feature.group = case_when(feature.group == 'Activation/Differentiation' ~ 'Activ/Diff',
                                   feature.group == 'Stemness' ~ 'Stem.',
                                   feature.group == 'SIV-specific' ~ 'SIV-spec.',
                                   feature.group == 'Stemness' ~ 'Stem.',
                                   feature.group == 'Exhaustion' ~ 'Exhaust.',
                                   TRUE ~  feature.group))

# Load raw data
join.data <- read_tsv('data/raw_clean/flow_raw_values_signif_features.tsv') %>% 
  filter(feature %in% c('wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live', 
                        df$feature)) %>% 
  select(animal, feature, value, tissue) 
  
# Add feature annotation
join.data.class <- join.data %>% 
  mutate(timepoint= case_when(grepl('wk12', feature) == T ~ 'wk0',
                              grepl('wk21', feature) == T ~ 'wk9',
                            grepl('wk36', feature) == T ~ 'wk24',
                            TRUE ~ NA_character_)) %>% 
  mutate(cell = case_when(grepl('_CD3n', feature) == T ~ 'CD3n',
                          grepl('_CD4', feature) == T ~ 'CD4p',
                          grepl('_CD8', feature) == T ~ 'CD8p',
                          grepl('_CD4', feature) == F & grepl('_CD8', feature) == F &
                          grepl('_CD3p', feature) == T ~ 'CD3p',
                          ((grepl('wk12_', feature) == T) | 
                          (grepl('wk36_', feature) == T)) & 
                          grepl('_CD4', feature) == F & grepl('_CD8', feature) == F &
                          grepl('_CD3', feature) == F ~ 'cytokine',
                          TRUE ~ NA_character_)) %>% 
  mutate(readout = case_when(grepl('log', feature) == T ~ 'readout',
                             grepl('LOG', feature) == T ~ 'readout',
                            TRUE ~ NA_character_)) %>% 
  arrange(tissue, timepoint, cell, readout) %>% 
  unite('Class', tissue:timepoint:cell:readout, na.rm = T, remove = F) %>% 
  select(-c(animal, value)) %>% 
  mutate(tissue = ifelse(cell == 'cytokine', 'PBMC', tissue)) %>% 
  mutate(tissue = ifelse(!is.na(readout), 'LN', tissue)) %>% 
  mutate(timepoint = ifelse(!is.na(readout), 'wk24', timepoint)) %>% 
  mutate(cell = ifelse(!is.na(readout), 'readout', cell)) %>% 
  unique()  %>% 
  full_join(df %>% rename(`MODULE NAME` = feature.group))  %>% 
  mutate(`MODULE NAME` = case_when(cell == 'cytokine' ~ gsub('.*_', '', feature),
                                   cell == 'readout' ~ 'SIV-RNA',
                                   TRUE ~ `MODULE NAME`)) %>%
  mutate(`MODULE NAME` = ifelse(cell == 'cytokine', 
                                paste0(`MODULE NAME`, '.Plasma'), `MODULE NAME`)) %>% 
  filter(!is.na(`MODULE NAME`)) %>% 
  mutate(`UNIQUE MODULE NAME` = paste(tissue, timepoint, `MODULE NAME`, sep = '_'))  %>% 
  group_by(`UNIQUE MODULE NAME`) %>% 
  mutate(Class.size = n()) %>% 
  ungroup()

#write.table(join.data.class, 
#            'results/selected_features_wk12_21_36_cytok_siv-espc_tfh_bcl2.tsv')
  
# Calculate correlation across all features and SIV-RNA
join.data.corr <- join.data %>%
  select(-tissue) %>% 
  pivot_wider(names_from = feature, values_from = value) %>% 
  cor_test(-c(animal), method = 'spearman')

# Filter correlations with p-val < 0.05 and add feature class annot.
join.data.corr.ft <- join.data.corr %>% 
  filter(p < 0.05, var1 != var2) %>% 
  left_join(join.data.class %>% select(feature, `UNIQUE MODULE NAME`) %>% unique(), 
            by = c('var1' = 'feature')) %>% 
  rename(var1.Class = `UNIQUE MODULE NAME`) %>% 
  left_join(join.data.class %>% select(feature, `UNIQUE MODULE NAME`) %>% unique(), 
            by = c('var2' = 'feature')) %>% 
  rename(var2.Class = `UNIQUE MODULE NAME`) %>% 
  relocate(var1, var1.Class, var2, var2.Class)

# Count number of pos. and neg. correlations between classes
correlated.features.count <- join.data.corr.ft %>% 
  group_by(var1.Class, var2.Class) %>% 
  summarise(pos.cor = sum(cor > 0), neg.cor = sum(cor < 0))

# Median positive correlation between classes
correlated.features.median.pos.cor <- join.data.corr.ft %>% 
  filter(cor > 0) %>% 
  group_by(var1.Class, var2.Class) %>% 
  summarise(median.pos.cor = median(cor))

# Median negative correlation between classes
correlated.features.median.neg.cor <- join.data.corr.ft %>% 
  filter(cor < 0) %>% 
  group_by(var1.Class, var2.Class) %>% 
  summarise(median.neg.cor = median(cor))

# Table with median correlation, class size and class proportion
# + remove reversed correlations (AvsB = BvsA)
correlated.features.data <- correlated.features.count %>% 
  full_join(correlated.features.median.pos.cor)  %>% 
  full_join(correlated.features.median.neg.cor) %>% 
  full_join(join.data.class %>% 
              dplyr::select(`UNIQUE MODULE NAME`, Class.size) %>% unique, 
            by = c('var1.Class' = 'UNIQUE MODULE NAME')) %>% 
  full_join(join.data.class %>% 
              dplyr::select(`UNIQUE MODULE NAME`, Class.size)%>% unique, 
            by = c('var2.Class' = 'UNIQUE MODULE NAME')) %>% 
  mutate(int.size = Class.size.x*Class.size.y) %>%  
  mutate(pos.cor.prop = pos.cor/int.size, neg.cor.prop = neg.cor/int.size)  %>% 
  ungroup() %>%
  group_by(grp = paste(pmax(var1.Class, var2.Class), 
                      pmin(var1.Class, var2.Class), sep = "")) %>%
  slice(1) %>%
  ungroup() 

# Extract negative correlations
neg.cor <- correlated.features.data %>% 
  select(-c(pos.cor, median.pos.cor, pos.cor.prop), -contains('size')) %>% 
  rename(correl.ft = neg.cor, median.cor = median.neg.cor, 
         cor.prop = neg.cor.prop) %>% 
  na.omit()

# Extract positive correlations
pos.cor <- correlated.features.data %>% 
  select(-c(neg.cor, median.neg.cor, neg.cor.prop), -contains('size')) %>% 
  rename(correl.ft = pos.cor, median.cor = median.pos.cor,
         cor.prop = pos.cor.prop) %>% 
  na.omit()

# Bind pos. + neg. correlations and filter out classes pairs with 
# less than %50 possible correlations
correl.features.tidy <- pos.cor %>% 
  bind_rows(neg.cor) %>% 
  arrange(var1.Class, var2.Class) %>% 
  mutate(cor = ifelse(median.cor < 0 , 'neg', 'pos')) %>% 
  relocate(var1.Class, var2.Class, cor) %>% 
  filter(cor.prop >= 0.5)

#### CHORD DIAGRAM
df <- correl.features.tidy %>% 
  filter(var1.Class != var2.Class,  !grepl('SIV-RNA', grp)) %>% 
  select(var1.Class, var2.Class, cor.prop) 

group <- correl.features.tidy %>% 
  filter(grepl('SIV-RNA', grp)) %>% 
  mutate(grp = sub('LN_wk24_SIV-RNA', '', grp)) %>%  
  mutate(class = sub("^((?:[^;]*_){2}).*", "\\1", grp)) %>% 
  mutate(class = sub('_$', '', class)) %>% 
  mutate(class = factor(class, levels = c("LN_wk24", "LN_wk9", "LN_wk0", 
                                          "PBMC_wk0", "PBMC_wk9", "PBMC_wk24"))) %>% 
  group_by(class) %>% 
  arrange(class, median.cor) %>% 
  select(grp, class) %>% 
  deframe()

colfun = colorRampPalette(c('darkblue', 'blue', 'white', 'red', 'darkred'))

y <- correl.features.tidy %>%
  filter(var1.Class != var2.Class, !grepl('SIV-RNA', grp)) %>%
  select(var1.Class, var2.Class, median.cor) %>% 
  mutate(link.col = colorRamp2(seq(-1,1, length.out = 100), 
                               colfun(100))(median.cor))

# Color code with median correlation so SIV-RNA
siv.median.cor <- correl.features.tidy %>% 
  filter(grepl('SIV-RNA', grp)) %>%
  mutate(grid.col = colorRamp2(seq(-1,1, length.out = 100), 
                               turbo(100))(median.cor))  %>% 
  mutate(grp = sub('LN_wk24_SIV-RNA', '', grp)) %>% 
  select(grp, grid.col) %>% 
  deframe()
  
correl_chord = function() {
  circos.par(start.degree = 90)
  
  # Plot chord diagram
  chordDiagram(df, group = group, annotationTrack = "grid", transparency = 0.3 ,
               grid.col = siv.median.cor, col = y$link.col, big.gap = 5,
               small.gap = 1, preAllocateTracks = list(track.height = 0.1),
               annotationTrackHeight = 0.1)
  
   # Add inner sector labels
  circos.track(track.index = 2, 
               panel.fun = function(x, y) {
                 sn = CELL_META$sector.index
                 i_state = gsub('.*_', '', sn)
                 circos.text(CELL_META$xcenter, CELL_META$ycenter, i_state, 
                             col = "black", font = 2, cex = 0.5 , 
                             facing = "bending.inside",
                             niceFacing = TRUE) }, 
               bg.border = NA)
               
  # Add outer  sectors
  highlight.sector(unique(names(group[group == "LN_wk0"])), track.index = 1, 
                   col = "#A6DBA0", text = "LN wk0", font = 2,cex = 1, 
                   text.col = "white", niceFacing = TRUE,
                   facing = "bending.inside")
  highlight.sector(unique(names(group[group == "LN_wk9"])), track.index = 1, 
                   col = "#5AAE61", text = "LN wk9", font = 2,cex = 1, 
                   text.col = "white", niceFacing = TRUE,
                   facing = "bending.inside")
  highlight.sector(unique(names(group[group == "LN_wk24"])), track.index = 1, 
                   col = "#1B7837", text = "LN wk24", font = 2,cex = 1, 
                   text.col = "white", niceFacing = TRUE,
                   facing = "bending.inside")
  highlight.sector(unique(names(group[group == "PBMC_wk0"])), track.index = 1,
                   col = "#C2A5CF", text = "PBMC wk0",font = 2, cex = 1, 
                   text.col = "white", niceFacing = TRUE,
                   facing = "bending.inside")
  highlight.sector(unique(names(group[group == "PBMC_wk9"])), track.index = 1,
                   col = "#9970AB", text = "PBMC wk9",font = 2, cex = 1, 
                   text.col = "white", niceFacing = TRUE,
                   facing = "bending.inside")
  highlight.sector(unique(names(group[group == "PBMC_wk24"])), track.index = 1, 
                   col = "#762A83", text = "PBMC wk24",font = 2, cex = 1, 
                   text.col = "white", niceFacing = TRUE,
                   facing = "bending.inside")
  
  circos.clear()
}

# continuous
col_fun.ft = colorRamp2(seq(-1,1, length.out = 100), 
           colorRampPalette(c('darkblue', 'blue', 'white', 'red', 'darkred'))(100))
lgd_links.ft= Legend(at = c(-1, 0, 1), col_fun = col_fun.ft, 
    title_position = "topleft", title = "Median correlation")

col_fun.siv = colorRamp2(seq(-1,1, length.out = 100), turbo(100))
lgd_links.siv = Legend(at = c(-1, 0, 1), col_fun = col_fun.siv, 
    title_position = "topleft", title = "Median correlation to SIV RNA")

lgd_list_vertical = packLegend( lgd_links.siv, lgd_links.ft)

## plot
plot.new()
pushViewport(viewport(x = 0, y = 0))
par(omi = c(0,0,0,0), new = TRUE)

correl_chord()

upViewport()
draw(lgd_list_vertical, x = unit(4, "mm"), y = unit(4, "mm"), 
     just = c("left", "bottom")) 
```

```{r Extended 1D - IL10 Longitudinal}
df <- read_tsv('data/raw_clean/il10_longitudinal_20230426.tsv')

stat.test <- df %>% 
  filter(!(`weeks post-ATI` %in% c(11,14,18,22))) %>% 
  group_by(`weeks post-ATI`) %>% 
  wilcox_test(`IL10 Pr (pg/ml)` ~ Group) %>% 
  add_significance("p") %>% 
  add_xy_position(x = "weeks post-ATI")

il10.plot <- df %>%
  ggplot(aes(x = `weeks post-ATI`, y = `IL10 Pr (pg/ml)`)) +
  geom_boxplot(aes(group = interaction(`weeks post-ATI`, Group), fill = Group),
              outlier.shape = NA, alpha = 0.7, lwd = 0.2,
              position =  position_dodge2(width = 0.75, preserve = "single")) +
  geom_smooth(aes(color = Group), se = F, alpha = 0.7,linewidth = 0.5,
              method = lm, formula = y ~ splines::bs(x, df = 8)) +
  scale_y_continuous(trans = 'log10') +
  scale_fill_manual(values = c('red', 'blue')) +
  scale_colour_manual(values = c('red', 'blue'), ) +
  theme_bw() +
  stat_pvalue_manual(stat.test, xmin = "weeks post-ATI", xmax = NULL, hide.ns = T,
                     label = "p.signif", size = 6) +
  xlab('Weeks post-ATI') + 
  theme_prism()+
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        legend.title = element_text())
          
il10.plot
#ggsave('results/figures/EDFig1/IL10_longitudinal.pdf', 
#       il10.plot, device = 'pdf', scale = 0.7)
```

```{r Extended 6D-F - Heatmaps}
heatmap.df <- read_tsv('data/raw_clean/extended_6df_heatmaps.tsv')

colors = colorRampPalette(c('darkblue', 'blue', 'white', 'red', 'darkred'))(100)

## Wk 0 ----
features_wk0 <- heatmap.df %>% 
  filter(feature == 'wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live' |
           `WkPost-TX` == 12) %>% 
  select(animal, group, feature, value) %>% 
  pivot_wider(names_from = feature, values_from = value) %>% 
  relocate(animal, group, `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`) %>% 
  arrange(`wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`) %>% 
  filter(rowMeans(is.na(.)) < 0.4) %>% 
  rename(Group = group,
         `Log CA-vRNA LN 24 weeks post-ATI` = `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`)

exprs <- features_wk0 %>% 
  column_to_rownames('animal') %>% 
  select(-c(Group, `Log CA-vRNA LN 24 weeks post-ATI`))

pheno <- features_wk0 %>% 
  column_to_rownames('animal') %>% 
  select(c(Group, `Log CA-vRNA LN 24 weeks post-ATI`))

featureData <- features_wk0 %>% 
  pivot_longer(-c(Group, animal, `Log CA-vRNA LN 24 weeks post-ATI`),
               names_to = 'features') %>% 
  select(features) %>% 
  unique() %>% 
  mutate(`Weeks post-ATI` = '0', 
         Tissue = ifelse(grepl('PBMC', features), 'PBMC', 'LN'),
         Subset = ifelse(grepl('CD4', features), 'CD4+', 'CD8+')) %>% 
  column_to_rownames('features')

group <- c('blue', 'red', 'black')
names(group) = c('aIL10+aPD1', 'aIL10', 'Control')

week <- c('white')
names(week) <- '0'

tissue <- c('orange', 'lightblue')
names(tissue) <- c('LN', 'PBMC')

subset <- c('pink', 'lightgreen')
names(subset) <- c('CD4+', 'CD8+')

annotCol = list(Group = group, `Weeks post-ATI` = week,
                Tissue = tissue, Subset = subset)

row_labels <- t(exprs) %>% 
  as.data.frame() %>% 
  rownames_to_column('feature') %>% 
  mutate(feature = gsub('^(?:[^_]*_){4}', '', feature)) %>% 
  select(feature) %>% 
  deframe

pheatmap::pheatmap(log1p(t(exprs)), scale = 'row', color = colors,
                   show_colnames = F, cellwidth = 10, cellheight = 10, 
                   fontsize = 8, annotation_col = pheno,
                   annotation_row = featureData,
                   cluster_cols = F, annotation_colors = annotCol, 
                   labels_row = row_labels,
                   main = 'Pre-ATI (Week 0)', 
                   filename = 'results/figures/EDFig6/heatmap_SIVRNA_correl_week0_postATI.pdf')

## Wk 9 ----
features_wk9 <- heatmap.df %>% 
  filter(feature == 'wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live' |
           `WkPost-TX` == 21) %>% 
  select(animal, group, feature, value) %>% 
  pivot_wider(names_from = feature, values_from = value) %>% 
  relocate(animal, group, `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`) %>% 
  arrange(`wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`) %>% 
  filter(rowMeans(is.na(.)) < 0.4) %>% 
  rename(Group = group,
         `Log CA-vRNA LN 24 weeks post-ATI` = `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`)

exprs <- features_wk9 %>% 
  column_to_rownames('animal') %>% 
  select(-c(Group, `Log CA-vRNA LN 24 weeks post-ATI`))

pheno <- features_wk9 %>% 
  column_to_rownames('animal') %>% 
  select(c(Group, `Log CA-vRNA LN 24 weeks post-ATI`))

featureData <- features_wk9 %>% 
  pivot_longer(-c(Group, animal, `Log CA-vRNA LN 24 weeks post-ATI`),
               names_to = 'features') %>% 
  select(features) %>% 
  unique() %>% 
  mutate(`Weeks post-ATI` = '9', 
         Tissue = ifelse(grepl('PBMC', features), 'PBMC', 'LN'),
         Subset = ifelse(grepl('CD4', features), 'CD4+', 'CD8+')) %>% 
  column_to_rownames('features')

group <- c('blue', 'red', 'black')
names(group) = c('aIL10+aPD1', 'aIL10', 'Control')

week <- c('yellow')
names(week) <- '9'

tissue <- c('orange', 'lightblue')
names(tissue) <- c('LN', 'PBMC')

subset <- c('pink', 'lightgreen')
names(subset) <- c('CD4+', 'CD8+')

annotCol = list(Group = group, `Weeks post-ATI` = week,
                Tissue = tissue, Subset = subset)

row_labels <- t(exprs) %>% 
  as.data.frame() %>% 
  rownames_to_column('feature') %>% 
  mutate(feature = gsub('^(?:[^_]*_){4}', '', feature)) %>% 
  select(feature) %>% 
  deframe

pheatmap::pheatmap(log1p(t(exprs)), scale = 'row', color = colors,
                   show_colnames = F, cellwidth = 10, cellheight = 10, 
                   fontsize = 8, annotation_col = pheno,
                   annotation_row = featureData,
                   labels_row = row_labels,
                   cluster_cols = F, annotation_colors = annotCol,
                   main = 'Week 9 post-ATI',
                   filename = 'results/figures/EDFig6/heatmap_SIVRNA_correl_week9_postATI.pdf')

## Wk 24 ----
features_wk24 <- heatmap.df %>% 
  filter(feature == 'wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live' |
           `WkPost-TX` == 36) %>% 
  select(animal, group, feature, value) %>% 
  pivot_wider(names_from = feature, values_from = value) %>% 
  relocate(animal, group, `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`) %>% 
  arrange(`wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`) %>% 
  filter(rowMeans(is.na(.)) < 0.4) %>% 
  rename(Group = group,
         `Log CA-vRNA LN 24 weeks post-ATI` = `wk36_LOG_SIVRNA_LN_per10^6correctedCD4Live`)

exprs <- features_wk24 %>% 
  column_to_rownames('animal') %>% 
  select(-c(Group, `Log CA-vRNA LN 24 weeks post-ATI`))

pheno <- features_wk24 %>% 
  column_to_rownames('animal') %>% 
  select(c(Group, `Log CA-vRNA LN 24 weeks post-ATI`))

featureData <- features_wk24 %>% 
  pivot_longer(-c(Group, animal, `Log CA-vRNA LN 24 weeks post-ATI`),
               names_to = 'features') %>% 
  select(features) %>% 
  unique() %>% 
  mutate(`Weeks post-ATI` = '24', 
         Tissue = ifelse(grepl('PBMC', features), 'PBMC', 'LN'),
         Subset = ifelse(grepl('CD4', features), 'CD4+', 'CD8+')) %>% 
  column_to_rownames('features')

group <- c('blue', 'red', 'black')
names(group) = c('aIL10+aPD1', 'aIL10', 'Control')

week <- c('purple')
names(week) <- '24'

tissue <- c('orange', 'lightblue')
names(tissue) <- c('LN', 'PBMC')

subset <- c('pink', 'lightgreen')
names(subset) <- c('CD4+', 'CD8+')

annotCol = list(Group = group, `Weeks post-ATI` = week,
                Tissue = tissue, Subset = subset)

row_labels <- t(exprs) %>% 
  as.data.frame() %>% 
  rownames_to_column('feature') %>% 
  mutate(feature = gsub('^(?:[^_]*_){4}', '', feature)) %>% 
  select(feature) %>% 
  deframe

pheatmap::pheatmap(log1p(t(exprs)), scale = 'row', color = colors,
                   show_colnames = F, cellwidth = 10, cellheight = 10, 
                   fontsize = 8, annotation_col = pheno,
                   annotation_row = featureData,
                   labels_row = row_labels,
                   cluster_cols = F, annotation_colors = annotCol,
                   main = 'Week 24 post-ATI',
                   filename = 'results/figures/EDFig6/heatmap_SIVRNA_correl_week24_postATI.pdf')
```

